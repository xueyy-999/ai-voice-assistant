# VoicePC 部署指南

## 📋 目录

1. [环境要求](#环境要求)
2. [本地开发部署](#本地开发部署)
3. [生产环境部署](#生产环境部署)
4. [Docker部署](#docker部署)
5. [常见问题](#常见问题)

---

## 🖥️ 环境要求

### 硬件要求

| 项目 | 最低配置 | 推荐配置 |
|-----|---------|---------|
| CPU | 双核 2.0GHz | 四核 3.0GHz+ |
| 内存 | 4GB | 8GB+ |
| 硬盘 | 5GB可用空间 | 10GB+ SSD |
| 网络 | 宽带网络 | 稳定高速网络 |

### 软件要求

- **操作系统**: Windows 10/11（64位）
- **Node.js**: v18.x 或更高
- **Python**: 3.10 或更高
- **Git**: 最新版本

---

## 🚀 本地开发部署

### 1. 克隆项目

```bash
git clone https://github.com/xueyy-999/ai-voice-assistant.git
cd ai-voice-assistant
```

### 2. 后端部署

#### 2.1 安装Python依赖

```bash
cd backend
pip install -r requirements.txt
```

**可能遇到的问题**：

- **SSL证书错误**: 使用国内镜像
```bash
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt
```

- **编译错误**: 某些包需要C++编译器
  - 安装 [Visual Studio Build Tools](https://visualstudio.microsoft.com/downloads/)
  - 或使用预编译版本

#### 2.2 配置环境变量

复制`.env.example`为`.env`：

```bash
cp .env.example .env
```

编辑`.env`文件：

```env
# DeepSeek API配置
DEEPSEEK_API_KEY=your_deepseek_api_key_here
DEEPSEEK_API_BASE=https://api.deepseek.com

# 阿里云语音配置（可选）
ALI_APPKEY=your_ali_appkey_here
ALI_ACCESS_KEY_ID=your_access_key_id
ALI_ACCESS_KEY_SECRET=your_access_key_secret

# 服务配置
HOST=0.0.0.0
PORT=8000
DEBUG=True

# 数据库配置
DATABASE_PATH=./data/voicepc.db
```

#### 2.3 启动后端

```bash
python run_backend.py
```

成功启动后会看到：

```
INFO:     Uvicorn running on http://0.0.0.0:8000
INFO:     Application startup complete.
```

### 3. 前端部署

#### 3.1 安装Node.js依赖

```bash
cd frontend
npm install
```

**可能遇到的问题**：

- **网络超时**: 使用国内镜像
```bash
npm config set registry https://registry.npmmirror.com
npm install
```

- **权限错误**: 
```bash
npm install --legacy-peer-deps
```

#### 3.2 配置环境变量（可选）

创建`frontend/.env`：

```env
VITE_API_BASE_URL=http://localhost:8000/api
VITE_WS_URL=ws://localhost:8000/api/chat/ws
```

#### 3.3 启动前端

```bash
npm run dev
```

访问 http://localhost:5173

### 4. 验证部署

1. 打开浏览器访问前端地址
2. 点击麦克风按钮测试语音输入
3. 查看后端日志确认请求正常

---

## 🏭 生产环境部署

### 1. 后端生产部署

#### 1.1 使用Gunicorn（推荐）

```bash
# 安装Gunicorn
pip install gunicorn

# 启动服务（4个工作进程）
gunicorn backend.app.main:app \
  --workers 4 \
  --worker-class uvicorn.workers.UvicornWorker \
  --bind 0.0.0.0:8000 \
  --access-logfile logs/access.log \
  --error-logfile logs/error.log \
  --daemon
```

#### 1.2 配置Nginx反向代理

创建`/etc/nginx/sites-available/voicepc`：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端静态文件
    location / {
        root /path/to/frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    # 后端API
    location /api {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # WebSocket
    location /api/chat/ws {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/voicepc /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

#### 1.3 配置系统服务

创建`/etc/systemd/system/voicepc.service`：

```ini
[Unit]
Description=VoicePC Backend Service
After=network.target

[Service]
Type=notify
User=voicepc
WorkingDirectory=/path/to/ai-voice-assistant/backend
Environment="PATH=/usr/local/bin:/usr/bin:/bin"
ExecStart=/usr/local/bin/gunicorn app.main:app \
  --workers 4 \
  --worker-class uvicorn.workers.UvicornWorker \
  --bind 0.0.0.0:8000
Restart=always

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl start voicepc
sudo systemctl enable voicepc
sudo systemctl status voicepc
```

### 2. 前端生产部署

#### 2.1 构建前端

```bash
cd frontend
npm run build
```

生成的文件在`frontend/dist`目录。

#### 2.2 部署到服务器

```bash
# 上传到服务器
scp -r dist/* user@server:/var/www/voicepc/

# 或使用rsync
rsync -avz dist/ user@server:/var/www/voicepc/
```

---

## 🐳 Docker部署

### 1. 创建Dockerfile

**后端Dockerfile** (`backend/Dockerfile`)：

```dockerfile
FROM python:3.10-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# 安装Python依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制代码
COPY . .

# 暴露端口
EXPOSE 8000

# 启动命令
CMD ["python", "run_backend.py"]
```

**前端Dockerfile** (`frontend/Dockerfile`)：

```dockerfile
FROM node:18-alpine AS builder

WORKDIR /app

# 安装依赖
COPY package*.json ./
RUN npm install

# 构建
COPY . .
RUN npm run build

# 生产环境
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### 2. 创建docker-compose.yml

```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - ALI_APPKEY=${ALI_APPKEY}
    volumes:
      - ./backend/data:/app/data
      - ./backend/logs:/app/logs
    restart: always

  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: always
```

### 3. 启动服务

```bash
# 启动
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止
docker-compose down
```

---

## 🔧 性能优化

### 1. 后端优化

- **工作进程数**: 根据CPU核心数配置（通常为核心数×2）
- **连接池**: 配置数据库连接池
- **缓存**: 使用Redis缓存热数据
- **日志**: 配置日志轮转，避免日志文件过大

### 2. 前端优化

- **CDN**: 使用CDN加速静态资源
- **压缩**: 启用gzip/brotli压缩
- **缓存**: 配置浏览器缓存策略
- **懒加载**: 组件按需加载

---

## 🔒 安全建议

1. **API密钥**: 不要将密钥提交到代码仓库
2. **HTTPS**: 生产环境必须使用HTTPS
3. **防火墙**: 只开放必要的端口
4. **限流**: 实现API请求频率限制
5. **日志**: 记录所有访问日志，定期审计

---

## 📊 监控与日志

### 1. 日志配置

后端日志路径：`backend/logs/`
- `app.log` - 应用日志
- `error.log` - 错误日志
- `access.log` - 访问日志

### 2. 监控指标

建议监控以下指标：
- CPU使用率
- 内存使用率
- 请求响应时间
- 错误率
- WebSocket连接数

可使用工具：
- **Prometheus + Grafana** - 指标收集和可视化
- **ELK Stack** - 日志分析
- **Sentry** - 错误追踪

---

## ❓ 常见问题

### Q1: 后端启动失败，提示模块找不到

**解决方案**：
```bash
# 确保在backend目录下
cd backend
# 使用run_backend.py启动
python run_backend.py
```

### Q2: 前端连接不上后端

**检查步骤**：
1. 确认后端已启动（访问 http://localhost:8000/docs）
2. 检查前端环境变量配置
3. 查看浏览器控制台网络请求

### Q3: WebSocket连接失败

**解决方案**：
1. 检查防火墙设置
2. 确认Nginx配置正确
3. 查看浏览器控制台错误信息

### Q4: 语音识别不工作

**检查步骤**：
1. 确认浏览器已授权麦克风权限
2. 检查API密钥配置
3. 查看后端日志错误信息

### Q5: 内存占用过高

**优化建议**：
1. 减少工作进程数
2. 实现会话清理机制
3. 配置日志轮转
4. 使用专业的AI服务而非本地模型

---

## 📞 技术支持

- **文档**: https://github.com/xueyy-999/ai-voice-assistant/tree/main/docs
- **Issues**: https://github.com/xueyy-999/ai-voice-assistant/issues
- **更新时间**: 2025年10月22日

---

## 🔄 更新日志

- **2025-10-22**: 初始版本发布
  - 完成本地开发部署指南
  - 添加Docker部署方案
  - 补充生产环境配置说明
