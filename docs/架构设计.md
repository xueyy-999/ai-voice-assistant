# VoicePC 架构设计文档

## 1. 项目概述

VoicePC 是一个基于大语言模型的 AI 语音控制电脑助手，通过自然语言语音交互实现对 Windows 系统的智能控制。

### 1.1 核心特性
- 🎤 **语音交互**：实时语音识别与合成
- 🤖 **AI 决策**：基于 LLM 的意图理解和任务规划
- 🛠️ **系统控制**：6 大工具插件覆盖日常操作
- 📊 **流程可视化**：实时展示 AI 决策过程
- 🎭 **场景管理**：预设复杂场景一键执行

## 2. 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      用户界面层 (Frontend)                    │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────────┐    │
│  │ Voice Button│  │ Chat Panel   │  │Flow Visualization│    │
│  └─────────────┘  └──────────────┘  └─────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              │
                    WebSocket & HTTP API
                              │
┌─────────────────────────────────────────────────────────────┐
│                      服务层 (Backend)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────────┐   │
│  │ Voice Service│  │ Agent Service│  │ Tool Registry   │   │
│  └──────────────┘  └──────────────┘  └─────────────────┘   │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────────┐   │
│  │Context Manager│  │Intent Parser │  │ Windows API    │   │
│  └──────────────┘  └──────────────┘  └─────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      外部服务层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────────┐   │
│  │ DeepSeek LLM │  │ Edge-TTS     │  │ Aliyun STT/TTS │   │
│  └──────────────┘  └──────────────┘  └─────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 3. 技术栈

### 3.1 前端技术栈
- **框架**: React 18 + TypeScript
- **构建工具**: Vite 5
- **状态管理**: Zustand
- **样式**: TailwindCSS
- **HTTP 客户端**: Axios
- **WebSocket**: 原生 WebSocket API
- **音频处理**: Web Audio API

### 3.2 后端技术栈
- **框架**: FastAPI
- **异步运行时**: Uvicorn
- **AI 框架**: LangChain
- **LLM**: DeepSeek API
- **语音服务**: Edge-TTS / Aliyun NLS
- **数据库**: SQLite (异步)
- **系统控制**: pyautogui, pywinauto, psutil

## 4. 核心模块设计

### 4.1 语音服务模块
```
voice/
├── audio_processor.py   # 音频格式处理
├── stt_service.py      # 语音识别服务
└── tts_service.py      # 语音合成服务
```

**功能**：
- PCM/WAV 音频格式转换
- Base64 编解码
- 多引擎支持（Aliyun/Local）
- 音量归一化

### 4.2 AI 决策模块
```
ai/
├── llm_client.py       # LLM 客户端封装
├── intent_parser.py    # 意图解析器
├── agent_service.py    # LangChain Agent
└── context_manager.py  # 上下文管理
```

**核心流程**：
1. 用户语音输入 → STT 转文本
2. 意图解析 → 提取动作和实体
3. Agent 决策 → 选择工具和参数
4. 执行工具 → 返回结果
5. 生成回复 → TTS 语音输出

### 4.3 工具插件系统
```
tools/
├── base_tool.py        # 工具基类
├── app_control.py      # 应用控制
├── file_operation.py   # 文件操作
├── browser_control.py  # 浏览器控制
├── text_processing.py  # 文本处理
├── media_control.py    # 媒体控制
└── scene_manager.py    # 场景管理
```

**工具列表**：
1. **AppControlTool**: 打开/关闭应用程序
2. **FileOperationTool**: 创建/打开/搜索文件
3. **BrowserControlTool**: 打开网页/搜索内容
4. **TextProcessingTool**: 创建文档/剪贴板操作
5. **MediaControlTool**: 音量控制/播放音乐/截图
6. **SceneManagerTool**: 工作/学习/休闲模式

### 4.4 Windows API 适配层
```python
class WindowsAPI:
    def start_process(self, app_path: str)
    def kill_process(self, process_name: str)
    def open_file(self, file_path: str)
    def set_volume(self, level: int)
    # ... 更多系统操作
```

## 5. 数据流设计

### 5.1 语音交互流程
```
[用户] --语音--> [麦克风] --PCM--> [Frontend]
                                      |
                                   WebSocket
                                      |
[Backend] --STT--> [文本] --Agent--> [决策]
                                      |
                                   [工具执行]
                                      |
[结果] --TTS--> [语音] --WebSocket--> [Frontend]
                                      |
                                   [扬声器]
```

### 5.2 实时通信协议
```typescript
// WebSocket 消息格式
interface WSMessage {
  type: 'user' | 'ai' | 'system' | 'step' | 'error'
  data: {
    content?: string
    audio?: string  // Base64
    step?: {
      tool: string
      params: any
      result: any
    }
  }
  timestamp: number
}
```

## 6. 安全设计

### 6.1 权限控制
- 危险操作二次确认
- 系统目录保护
- 命令注入防护

### 6.2 隐私保护
- 本地语音处理优先
- 会话数据本地存储
- API Key 环境变量管理

## 7. 性能优化

### 7.1 前端优化
- 音频流式传输
- 组件懒加载
- 状态更新批处理

### 7.2 后端优化
- 异步 I/O 操作
- 连接池管理
- LRU 缓存策略

## 8. 扩展性设计

### 8.1 插件化架构
- 工具基类抽象
- 自动注册机制
- 独立配置管理

### 8.2 多 LLM 支持
- 统一接口适配
- 模型切换机制
- Fallback 策略

## 9. 部署架构

### 9.1 开发环境
```bash
# 后端
python app/main.py

# 前端
npm run dev
```

### 9.2 生产部署
- Docker 容器化
- Nginx 反向代理
- PM2 进程管理

## 10. 技术亮点

1. **全异步架构**：充分利用 Python 异步特性
2. **流式处理**：音频/文本流式传输，低延迟
3. **插件化设计**：易于扩展新功能
4. **智能决策**：LangChain Agent 自主规划
5. **可视化流程**：实时展示 AI 思考过程

---

文档版本：1.0
更新日期：2025-10-21
