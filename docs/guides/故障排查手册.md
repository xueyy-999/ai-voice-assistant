# 🔧 VoicePC 故障排查手册

本手册帮助您快速定位和解决VoicePC使用过程中遇到的问题。

---

## 🎯 快速诊断

### 问题类别速查
- [启动问题](#启动问题) - 服务无法启动
- [语音问题](#语音问题) - 录音、识别相关
- [功能问题](#功能问题) - 命令执行失败
- [性能问题](#性能问题) - 运行缓慢、卡顿
- [网络问题](#网络问题) - 连接、API相关

---

## 🚀 启动问题

### 1. 后端无法启动

#### 症状
```
ModuleNotFoundError: No module named 'xxx'
```

#### 解决方案
```bash
# 重新安装依赖
cd backend
pip install -r requirements.txt

# 如果还失败，尝试
pip install -r requirements.txt --upgrade --force-reinstall
```

---

#### 症状
```
Port 8000 is already in use
```

#### 解决方案
```bash
# Windows
netstat -ano | findstr :8000
taskkill /PID <进程ID> /F

# 或修改端口
# 编辑 backend/app/config.py
PORT = 8001  # 改为其他端口
```

---

### 2. 前端无法启动

#### 症状
```
npm: 无法将"npm"项识别为 cmdlet
```

#### 解决方案
1. 下载安装Node.js: https://nodejs.org/
2. 重启命令行
3. 验证安装: `node --version`

---

#### 症状
```
Port 5174 is already in use
```

#### 解决方案
```bash
# 方法1: 杀死占用进程
npx kill-port 5174

# 方法2: 使用其他端口
npm run dev -- --port 5175
```

---

### 3. Python版本问题

#### 症状
```
ERROR: Could not find a version that satisfies the requirement
```

#### 解决方案
```bash
# 检查Python版本
python --version  # 需要 3.11+

# 如果版本过低，安装新版本
# 下载: https://www.python.org/downloads/
```

---

## 🎤 语音问题

### 1. 麦克风无法使用

#### 检查清单
- [ ] 浏览器是否授予麦克风权限
- [ ] Windows系统是否允许应用访问麦克风
- [ ] 麦克风设备是否正常工作
- [ ] 麦克风是否被其他应用占用

#### 详细步骤

**1. 浏览器权限**
```
Chrome: 设置 → 隐私和安全 → 网站设置 → 麦克风
Edge: 设置 → Cookie和网站权限 → 麦克风
```
确保 localhost 有权限

**2. Windows设置**
```
设置 → 隐私 → 麦克风 → 允许应用访问麦克风
```

**3. 测试麦克风**
```
设置 → 系统 → 声音 → 输入 → 测试麦克风
```

---

### 2. 语音识别不准确

#### 原因分析
| 原因 | 影响程度 | 解决方案 |
|------|---------|----------|
| 环境噪音大 | ⭐⭐⭐ | 换安静环境 |
| 口音重 | ⭐⭐ | 尽量标准普通话 |
| 网络延迟 | ⭐⭐⭐ | 检查网络 |
| API配额用完 | ⭐⭐⭐ | 更换API Key |

#### 优化建议
```
✅ 麦克风距离: 20-30cm
✅ 语速: 适中偏慢
✅ 音量: 正常说话音量
✅ 环境: 安静房间
```

---

### 3. 语音合成无声音

#### 检查步骤
1. **音量设置**
   - Windows系统音量 > 0
   - 浏览器未静音
   - 音箱/耳机已连接

2. **服务状态**
   ```bash
   # 查看TTS服务日志
   # 应该看到 "✅ TTS服务初始化成功"
   ```

3. **音频格式**
   - 浏览器是否支持MP3
   - 尝试切换音频格式

---

## ⚙️ 功能问题

### 1. 应用无法打开

#### 调试步骤

**Step 1: 确认应用已安装**
```bash
# 查看应用列表
python -c "from app.tools.app_control import AppControlTool; tool = AppControlTool(); print(tool.list_apps())"
```

**Step 2: 检查应用名称**
| 正确 ✅ | 错误 ❌ |
|---------|---------|
| "微信" | "WeChat" |
| "Chrome" | "谷歌浏览器" |
| "记事本" | "Notepad" |

**Step 3: 手动测试**
```python
from app.tools.app_control import AppControlTool
tool = AppControlTool()
result = tool.open_app("微信")
print(result)
```

---

### 2. 文件操作失败

#### 常见错误

**权限不足**
```
PermissionError: Access denied
```
解决: 以管理员身份运行

**路径不存在**
```
FileNotFoundError: path not found
```
解决: 使用绝对路径

**文件被占用**
```
PermissionError: being used by another process
```
解决: 关闭占用程序

---

### 3. 浏览器控制失效

#### 诊断方法

1. **检查浏览器进程**
   ```bash
   tasklist | findstr chrome
   ```

2. **测试WebDriver**
   ```python
   from selenium import webdriver
   driver = webdriver.Chrome()
   driver.get("https://www.baidu.com")
   ```

3. **更新ChromeDriver**
   - 下载: https://chromedriver.chromium.org/
   - 确保版本匹配Chrome版本

---

## 🐌 性能问题

### 1. 响应慢

#### 性能分析

**查看性能指标**
```bash
# 访问监控端点
curl http://localhost:8000/api/monitor/stats
```

**预期值**:
| 指标 | 正常值 | 警戒值 |
|------|--------|--------|
| STT延迟 | < 1s | > 2s |
| LLM响应 | < 2s | > 5s |
| 工具执行 | < 1s | > 3s |

#### 优化方案

**1. 音频处理优化**
```python
# backend/app/services/voice/audio_processor.py
CHUNK_SIZE = 2048  # 已优化，无需修改
```

**2. 缓存优化**
```python
# 启用结果缓存
ENABLE_CACHE = True
CACHE_TTL = 3600
```

**3. 并发限制**
```python
# 限制并发请求
MAX_CONCURRENT = 10
```

---

### 2. 内存占用高

#### 诊断命令
```bash
# Windows
tasklist | findstr python

# 查看详细内存
wmic process where name="python.exe" get ProcessId,WorkingSetSize
```

#### 解决方案

**1. 清理缓存**
```python
# 定期清理
python -c "from app.services.ai.context_manager import context_mgr; context_mgr.clear()"
```

**2. 限制上下文长度**
```python
# backend/app/services/ai/context_manager.py
CONTEXT_MAX_HISTORY = 5  # 降低到5轮
```

**3. 重启服务**
```bash
# 每隔一段时间重启
```

---

### 3. CPU占用高

#### 排查步骤

1. **识别耗时操作**
   ```bash
   # 查看日志中的慢请求
   # ⏱️ 慢请求告警: xxx 耗时 x.xxs
   ```

2. **优化音频处理**
   - 使用GPU加速（可选）
   - 降低采样率
   - 减少音频处理步骤

3. **限制并发**
   ```python
   MAX_CONCURRENT_REQUESTS = 5  # 降低并发
   ```

---

## 🌐 网络问题

### 1. API连接失败

#### DeepSeek API

**症状**
```
ERROR: Failed to connect to DeepSeek API
```

**检查清单**
- [ ] API Key是否正确
- [ ] 网络是否通畅
- [ ] API配额是否用完
- [ ] API服务是否正常

**测试连接**
```bash
curl -X POST https://api.deepseek.com/v1/chat/completions \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"model": "deepseek-chat", "messages": [{"role": "user", "content": "hello"}]}'
```

---

### 2. WebSocket断开

#### 症状
```
WebSocket connection closed
```

#### 解决方案

**1. 增加心跳间隔**
```python
# backend/app/api/chat.py
heartbeat_interval = 60  # 从30秒增加到60秒
```

**2. 自动重连**
前端会自动重连，无需手动处理

**3. 检查防火墙**
确保8000端口未被防火墙阻止

---

### 3. GitHub Push失败

#### 症状
```
fatal: unable to access 'https://github.com/...'
Connection was reset
```

#### 解决方案

**方法1: 重试**
```bash
git push origin main
```

**方法2: 使用代理**
```bash
git config --global http.proxy http://127.0.0.1:7890
```

**方法3: 使用SSH**
```bash
git remote set-url origin git@github.com:username/repo.git
git push origin main
```

---

## 🔍 日志分析

### 查看日志位置

**后端日志**
```
backend/logs/app.log
```

**前端日志**
```
浏览器控制台 (F12)
```

### 日志级别

| 级别 | 含义 | 示例 |
|------|------|------|
| DEBUG | 调试信息 | 详细执行流程 |
| INFO | 一般信息 | 请求处理完成 |
| WARNING | 警告 | 慢请求、高CPU |
| ERROR | 错误 | API调用失败 |
| CRITICAL | 严重错误 | 服务崩溃 |

### 常见日志模式

**正常请求**
```
📊 POST /api/voice/recognize | Status: 200 | Time: 0.856s
```

**慢请求**
```
⏱️ 慢请求告警: POST /api/chat/message 耗时 3.24s
```

**错误**
```
❌ POST /api/tools/execute | Error: PermissionError | Time: 0.123s
```

---

## 📞 获取支持

### 自助资源
1. 📖 [用户快速上手教程](./用户快速上手教程.md)
2. ❓ [常见问题FAQ](../../常见问题FAQ.md)
3. 📝 [运行说明](../运行说明.md)

### 提交问题
如果以上方法都无法解决，请提交Issue：
- GitHub: https://github.com/xueyy-999/ai-voice-assistant/issues
- 包含: 错误信息、日志截图、系统信息

---

## ✅ 预防措施

### 定期维护
- 📅 每周重启服务一次
- 🗑️ 每月清理日志和缓存
- 🔄 及时更新依赖包

### 最佳实践
- ✅ 保持网络稳定
- ✅ 使用推荐配置
- ✅ 定期备份数据
- ✅ 关注项目更新

---

**祝您使用顺畅！** 🎉

